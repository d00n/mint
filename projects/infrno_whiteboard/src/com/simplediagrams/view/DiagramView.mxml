<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
	xmlns:s="library://ns.adobe.com/flex/spark" 
	xmlns:mx="library://ns.adobe.com/flex/mx"
	xmlns:view="com.simplediagrams.view.*"
	creationComplete="onCC()"  >
	
	<s:layout>
		<s:BasicLayout/>
	</s:layout>

	<fx:Script> 
	
		<![CDATA[
			import com.simplediagrams.events.CopyEvent;
			import com.simplediagrams.events.DeleteSDObjectModelEvent;
			import com.simplediagrams.events.ExportDiagramEvent;
			import com.simplediagrams.events.ExportDiagramUserRequestEvent;
			import com.simplediagrams.events.PasteEvent;
			import com.simplediagrams.events.SaveDiagramEvent;
			import com.simplediagrams.events.SelectionEvent;
			import com.simplediagrams.events.UndoRedoEvent;
			import com.simplediagrams.model.ApplicationModel;
			import com.simplediagrams.model.DiagramModel;
			import com.simplediagrams.util.Logger;
			
			import flash.events.Event;
			import flash.events.KeyboardEvent;
			import flash.ui.Keyboard;
			
			import mx.core.FlexGlobals;
			import mx.core.UITextField;
			
			import spark.components.RichEditableText;
			
			[Dispatcher]
			public var dispatcher:IEventDispatcher;
		    
			[Bindable]
			[Inject]
			public var model:ApplicationModel;    
			
			[Bindable]
			[Inject]
			public var diagramModel:DiagramModel;  	
			
			/* This page catches all keyboard events not handled by menu controller. Later these should be moved to a special manager */			
			public function onCC():void
			{
				FlexGlobals.topLevelApplication.addEventListener(KeyboardEvent.KEY_DOWN, onKeyDown)	
			}
			
			
			/*Pass a reference to the view to the controller and let it take care of exporting */
			[Mediate(event='ExportDiagramUserRequestEvent.EXPORT_DIAGRAM')]
			public function onExportDiagramRequest(event:ExportDiagramUserRequestEvent):void
			{						
				event.stopImmediatePropagation()
										
				switch(event.destination)
				{
					case ExportDiagramUserRequestEvent.DESTINATION_BASECAMP:							
						var evt:ExportDiagramEvent = new ExportDiagramEvent(ExportDiagramEvent.EXPORT_TO_BASECAMP, true)
						break
					
					case ExportDiagramUserRequestEvent.DESTINATION_YAMMER:							
						evt = new ExportDiagramEvent(ExportDiagramEvent.EXPORT_TO_YAMMER, true)
						break
					
					case ExportDiagramUserRequestEvent.DESTINATION_FILE:							
						evt = new ExportDiagramEvent(ExportDiagramEvent.EXPORT_TO_FILE, true)					
						break
					
					default:
						
						Logger.debug("Unrecognized destination: " + event.destination, this)
						return
				}
				
				evt.format = ExportDiagramEvent.FORMAT_PNG //for now we're hard-coding to PNG
				evt.view = this.drawingBoard.holderGroup						
				dispatchEvent(evt)
				
			}
							
    		
			public function onKeyDown(event:KeyboardEvent):void
			{   			
				Logger.debug("onKeyDown() event:" + event.toString(),this)
				if (event.target is UITextField) return //user is typing in a text component
				if (event.target is RichEditableText) return //user is typing in a text area
				
				
				switch(event.keyCode)
				{
					case Keyboard.DELETE:
					case Keyboard.BACKSPACE:
						
						var deleteEvent:DeleteSDObjectModelEvent = new DeleteSDObjectModelEvent(DeleteSDObjectModelEvent.DELETE_SELECTED_FROM_MODEL, true)
						dispatchEvent(deleteEvent)
						break
					
					case (event.ctrlKey):
						Logger.debug("onKeyDown() caught a ctrl key press. event.charCode=" + event.charCode, this)
						Logger.debug("onKeyDown() caught a ctrl key press. event.keyCode=" + event.keyCode, this)
//						if (event.charCode == "S")
//						{
//							var evt:SaveDiagramEvent = new SaveDiagramEvent(SaveDiagramEvent.SAVE_DIAGRAM, true)
//							Swiz.dispatchEvent(evt)
//						}
//						
						break;
					
					case 65:  // a				
						if (event.ctrlKey)
						{
							Logger.debug("dispatching select all event...",this)
							var selectAllEvent:SelectionEvent = new SelectionEvent(SelectionEvent.SELECT_ALL, true)
							dispatchEvent(selectAllEvent)	
						}
						break
										
					case 67:  // c				
						if (event.ctrlKey)
						{
							Logger.debug("dispatching CopyEvent...",this)
							var copyEvent:CopyEvent = new CopyEvent(CopyEvent.COPY, true)
							dispatcher.dispatchEvent(copyEvent)
						}
						break
					
					case 86:  // v		
						if (event.ctrlKey )
						{
							Logger.debug("dispatching PasteEvent...",this)
							var pasteEvent:PasteEvent = new PasteEvent(PasteEvent.PASTE, true)
							dispatcher.dispatchEvent(pasteEvent)
						}
						break
					
					case 89: // y			
						if (event.ctrlKey )
						{
							Logger.debug("dispatching redo event...",this)
							var redoEvent:UndoRedoEvent = new UndoRedoEvent(UndoRedoEvent.REDO, true)
							dispatcher.dispatchEvent(redoEvent)
						}
						break

					case 90: // z		
						if (event.ctrlKey )
						{
							Logger.debug("dispatching undo event...",this)
							var undoEvent:UndoRedoEvent = new UndoRedoEvent(UndoRedoEvent.UNDO, true)
							dispatcher.dispatchEvent(undoEvent)
						}
						break
					
					
					default:
						//do nothing
				}
			}
			
//			public function onSelectAll(event:Event):void
//			{				
//				Logger.debug("dispatching select all event...",this)
//				var selectAllEvent:SelectionEvent = new SelectionEvent(SelectionEvent.SELECT_ALL, true)
//				dispatchEvent(selectAllEvent)				
//			}
			
			[Mediate(event='ShapesPanelEvent.TOGGLE_DISPLAY')]
			public function onShapesPanelToggle(): void
			{
				if (shapesPanel.width > 0){
					shapesPanel.width = 0;
				}
				else{
					shapesPanel.width = 124;
				}
			}  
			
            
    			    			
		]]>

	</fx:Script>
	
	

						
	<mx:HDividedBox styleName="libraryDivider" height="100%" width="100%"  >
					
			<view:DrawingBoard id="drawingBoard" height="100%" width="100%" />
			
			<view:ShapesPanel id="shapesPanel" height="100%" width="0" />	
		
	</mx:HDividedBox>
	
	
	<view:ToolPanel id="toolPanel" x="2" y="2" />
	
	<view:PercentView id="percentView" x="{drawingBoard.width/2 - 45}" top="10"/>
	

</s:Group>
